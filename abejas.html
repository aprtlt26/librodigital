<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Asegura responsividad -->
        <title>Estorninos: Mantarraya y Cara de Gato</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
        <style>
            body, html {
                margin: 0;
                padding: 0;
                overflow: hidden; /* Evita barras de desplazamiento */
            }
            #buttonContainer {
                position: absolute;
                top: 0;
                display: flex;
                justify-content: center;
                align-items: center;
                width: 100%;
                text-align: center;
                padding: 10px 0;
                background-color: #bdedf1;
            }
            button {
                margin: 5px;
                padding: 10px 20px;
                font-size: 16px;
                cursor: pointer;
                background-color: #93f2ff;
                color: white;
                border: none;
                border-radius: 5px;
            }
            button:hover {
                background-color: #13e0eb;
            }
            #subtitles {
                display: none;
                position: absolute;
                bottom: 0;
                width: 100%;
                text-align: center;
                color: white;
                background: rgba(0,0,0,0.5);
                padding: 10px;
            }
        </style>
    </head>
    
<body>
    <body>
        <div id="buttonContainer">
            <button id="prevButton">Anterior</button>
            <button id="nextButton">Siguiente</button>
            <button id="restartButton" style="display:none;">Reiniciar Juego</button>
            <button id="newGameButton" style="display:none;">Collage</button>
            <button id="subtitleButton" style="display:none;">Subtítulos</button>
        </div>
    </body>
    
    <div id="subtitles" style="display:none; position: absolute; bottom: 10px; width: 100%; text-align: center; color: white; background: rgba(0,0,0,0.5); padding: 10px;">
        Aquí aparecerán los subtítulos.
    </div>
    
    <script>
        let flock = [];
        let backgroundImage, cityImage, finalImage, fourthImage, fifthImage,  panalImage, boidImage;
        let panalPositions = [];
        let stage = 0;
        let backgroundTracks = [];
        let narrationTracks = [];
        let currentBackgroundSound, currentNarration;
        let panalDisappearSound;
        let video;

        function preload() {
            backgroundImage = loadImage('paisaje.png');
            cityImage = loadImage('ciudad.png');
            finalImage = loadImage('africa.png');
            fourthImage = loadImage('campomorado.png');
            fifthImage = loadImage('centro.png');
            panalImage = loadImage('panal.png');
            boidImage = loadImage('abeja.png');
            panalDisappearSound = loadSound('panal.mp3');

              video = createVideo(['abejas.mp4']);
    video.hide();  // Importante para asegurar que no se muestre fuera del canvas

            // Carga de tracks de fondo y narraciones
            for (let i = 1; i <= 6; i++) {
                backgroundTracks.push(loadSound(`background${i}.mp3`));
                if (i <= 6) {
                    narrationTracks.push(loadSound(`narration${i}.mp3`));
                }
            }
        }
        function setupButtons() {
    let prevButton = document.getElementById('prevButton');
    let nextButton = document.getElementById('nextButton');
    let restartButton = document.getElementById('restartButton');
    let newGameButton = document.getElementById('newGameButton');
    let subtitleButton = document.getElementById('subtitleButton');

    // Hacer que los botones "Nuevo Juego" y "Mostrar Subtítulos" siempre sean visibles
    newGameButton.style.display = 'block';
    subtitleButton.style.display = 'block';
    restartButton.style.display = 'block'; // Muestra el botón Nuevo Juego


    prevButton.onclick = function() {
        if (stage > 0) {
            stage--;
            changeStage(stage);
        }
    };

    nextButton.onclick = function() {
        if (stage < 5) {
            stage++;
            changeStage(stage);
        }
    };

    restartButton.onclick = function() {
        stage = 0;
        flock = []; // Reinicia la lista de boids
        initFlock(); // Inicializa de nuevo los boids
        setupPanales(3); // Configura los paneles inicialmente
        changeStage(stage); // Cambia a la primera etapa con todos los ajustes reiniciados
        // Estos botones permanecen siempre visibles, por lo tanto no se ajustan aquí.
    };

    newGameButton.onclick = function() {
        window.location.href = 'newGame.html'; // Cambia esto por la URL de tu nuevo juego
    };

    subtitleButton.onclick = function() {
        let subtitleDiv = document.getElementById('subtitles');
        if (subtitleDiv.style.display === 'none') {
            subtitleDiv.style.display = 'block';
        } else {
            subtitleDiv.style.display = 'none';
        }
    };
}

   
        

        function setup() {
    createCanvas(windowWidth, windowHeight);
    let cw = min(windowWidth);
    let ch = min(windowHeight);
    createCanvas(cw, ch);
    initFlock();
    setupAudioProcessing();
    setupPanales(3);
    setupButtons();
    changeStage(0);

    // Ajusta la posición del botón Collage al centro del canvas
}

function windowResized() {
    function windowResized() {
    resizeCanvas(windowWidth, windowHeight);
}
    // Re-posiciona elementos si es necesario
}



        function initFlock() {
    for (let i = 0; i < 80; i++) {
        flock.push(new Boid());
    }
    console.log('Boids reinicializados:', flock.length);
}

function setupPanales(count) {
    panalPositions = [];
    let margin = 70;  // Margen para evitar que los paneles aparezcan en los bordes
    for (let i = 0; i < count; i++) {
        let placed = false, attempts = 0;
        while (!placed && attempts < 100) {
            let candidatePosition = createVector(random(margin, width - margin), random(margin, height - margin));
            let tooClose = panalPositions.some(panal => p5.Vector.dist(candidatePosition, panal) < 80); // Aumenta la distancia mínima para evitar superposición
            if (!tooClose) {
                panalPositions.push(candidatePosition);
                placed = true;
            }
            attempts++;
        }
    }
    console.log('Paneles configurados:', panalPositions.length);
}

        function setupAudioProcessing() {
            let compressor = new p5.Compressor();
            compressor.threshold(-24);
            compressor.ratio(12);
            compressor.attack(0.003);
            compressor.release(0.25);
            let reverb = new p5.Reverb();
            reverb.process(compressor, 3, 3);
            flock.forEach(boid => boid.osc.connect(reverb));
        }
        
        function changeStage(newStage) {
    if (currentBackgroundSound) {
        currentBackgroundSound.stop();
    }
    if (currentNarration) {
        currentNarration.stop();
    }

    stage = newStage;

    let restartButton = document.getElementById('restartButton');
    let newGameButton = document.getElementById('newGameButton');
    let subtitleButton = document.getElementById('subtitleButton');

    if (stage === 6) { 
        video.loop();
        video.show();
        subtitleButton.style.display = 'block'; // Muestra el botón de Subtítulos
        newGameButton.style.display = 'block'; // Muestra el botón Nuevo Juego

    } else {
        video.loop();
        subtitleButton.style.display = 'block'; // Oculta el botón de Subtítulos fuera de la etapa del video
    }

    if (stage === 6) { // Final del juego
    } else {
        let backgrounds = [backgroundImage, cityImage, finalImage, fourthImage, fifthImage, backgroundImage, ];
        background(backgrounds[stage]);
        currentBackgroundSound = backgroundTracks[stage];
        currentBackgroundSound.loop();
        if (narrationTracks[stage]) {
            currentNarration = narrationTracks[stage];
            currentNarration.play();
        }
    }

    

    // Ajusta paneles o cualquier configuración específica de la etapa
    if (stage < 6) {
        setupPanales(stage < 6 ? 3 + stage : 0);
    }
}








        function draw() {
            if (stage === 5) {
                image(video, 0, 0, width, height);  // Muestra el video en el canvas
            } else {
                let currentBackground = [backgroundImage, cityImage, finalImage, fourthImage, fifthImage, ][stage];
                background(currentBackground);
                    panalPositions.forEach(panal => {
                        image(panalImage, panal.x, panal.y, 50, 50);
                    });
         
            flock.forEach(boid => {
                boid.edges();
                boid.flock(flock);
                boid.update();
                boid.show();
            });

            // Comprobar si se deben avanzar a la siguiente etapa
            if (panalPositions.length === 0 && stage < 3) {
                stage++;
                setupPanales(stage === 1 ? 4 : (stage === 2 ? 5 : 0));
            }
        }
 }

        function mousePressed() {
            for (let i = panalPositions.length - 1; i >= 0; i--) {
                let pos = panalPositions[i];
                if (dist(mouseX, mouseY, pos.x, pos.y) < 50) {
                    panalPositions.splice(i, 1);
                    panalDisappearSound.play();
                    if (panalPositions.length === 0) {
                        stage++;
                        changeStage(stage);
                    }
                }
            }
        }
        class Boid {
            constructor() {
                this.position = createVector(random(width), random(height));
                this.velocity = p5.Vector.random2D();
                this.velocity.setMag(random(2, 8));
                this.acceleration = createVector();
                this.maxForce = 1;
                this.maxSpeed = 8;
                this.perceptionRadius = 270;
                this.osc = new p5.Oscillator('sine');
                this.osc.freq(280);
                this.osc.amp(0.0);
                this.osc.start();
            }

            updateOscillator() {
                this.osc.freq(90 + this.velocity.mag() * 20);
                this.osc.pan(map(this.position.x, 0, width, 1, 1));
            }

            edges() {
                if (this.position.x > width) this.position.x = 0;
                if (this.position.x < 0) this.position.x = width;
                if (this.position.y > height) this.position.y = 0;
                if (this.position.y < 0) this.position.y = height;
            }

            align(boids) {
                let steering = createVector();
                let total = 0;
                for (let other of boids) {
                    let d = dist(this.position.x, this.position.y, other.position.x, other.position.y);
                    if (other !== this && d < this.perceptionRadius) {
                        steering.add(other.velocity);
                        total++;
                    }
                }
                if (total > 0) {
                    steering.div(total);
                    steering.setMag(this.maxSpeed);
                    steering.sub(this.velocity);
                    steering.limit(this.maxForce);
                }
                return steering;
            }

            cohesion(boids) {
                let steering = createVector();
                let total = 0;
                for (let other of boids) {
                    let d = dist(this.position.x, this.position.y, other.position.x, other.position.y);
                    if (other !== this && d < this.perceptionRadius) {
                        steering.add(other.position);
                        total++;
                    }
                }
                if (total > 0) {
                    steering.div(total);
                    steering.sub(this.position);
                    steering.setMag(this.maxSpeed);
                    steering.limit(this.maxForce);
                }
                return steering;
            }

            separation(boids) {
                let steering = createVector();
                let total = 0;
                for (let other of boids) {
                    let d = dist(this.position.x, this.position.y, other.position.x, other.position.y);
                    if (other !== this && d < this.perceptionRadius / 2) {
                        let diff = p5.Vector.sub(this.position, other.position);
                        diff.div(d);
                        steering.add(diff);
                        total++;
                    }
                }
                if (total > 0) {
                    steering.div(total);
                    steering.setMag(this.maxSpeed);
                    steering.limit(this.maxForce);
                }
                return steering;
            }

            followMouse() {
                let mouse = createVector(mouseX, mouseY);
                let steer = p5.Vector.sub(mouse, this.position);
                steer.setMag(this.maxSpeed);
                steer.sub(this.velocity);
                steer.limit(this.maxForce);
                this.acceleration.add(steer);
            }

            flock(boids) {
                let alignment = this.align(boids);
                let cohesion = this.cohesion(boids);
                let separation = this.separation(boids);
                let mouseForce = this.followMouse();
                this.acceleration.add(alignment);
                this.acceleration.add(cohesion);
                this.acceleration.add(separation);
                this.acceleration.add(mouseForce);
            }

            update() {
                this.position.add(this.velocity);
                this.velocity.add(this.acceleration);
                this.velocity.limit(this.maxSpeed);
                this.acceleration.mult(0);
                this.updateOscillator();
            }

      
            show() {
                push();
                imageMode(CENTER);
                translate(this.position.x, this.position.y);
                rotate(this.velocity.heading() + radians(90));
                image(boidImage, 0, 0, 20, 20);
                pop();
            }
        }
    </script>
</body>
</html>